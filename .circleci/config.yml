version: 2.1

jobs:
  # Job for running SonarQube scan using the SonarScanner CLI
  sonarqube_scan:
    docker:
      - image: sonarsource/sonar-scanner-cli  # SonarScanner image for Node.js project scan
    context: APDS_POE_CONTEXT
    steps:
      - checkout
      - run: apk --no-cache add --update openssh git curl  # Install required dependencies for the scan
      - run:
          name: Run SonarScanner
          command: |
            sonar-scanner \
              -Dsonar.projectKey=$SONAR_PROJECT_KEY \
              -Dsonar.organization=$SONAR_ORG \
              -Dsonar.host.url=$SONAR_HOST_URL \
              -Dsonar.login=$SONAR_TOKEN \
              -Dsonar.sources="Backend"  # Set to scan your backend source folder

  # Job for building and pushing Docker image
  build_and_push:
    docker:
      - image: docker:stable
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.7
      - run:
          name: Build Docker image
          command: docker build -t your-image-name .
      - run:
          name: Push Docker image
          command: docker push your-image-name

workflows:
  version: 2
  build_and_scan:
    jobs:
      - sonarqube_scan
      - build_and_push